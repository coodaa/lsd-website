name: Deploy Astro to Strato

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ§± Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install
        run: npm ci

      - name: ğŸ§° Build Astro
        run: npm run build
        env:
          WP_API: "https://lsd-backend.de/wp-json/wp/v2"

      - name: ğŸ—„ï¸ Install lftp
        run: sudo apt-get install -y lftp

      - name: ğŸš€ Upload to Strato
        run: |
          lftp -u "$STRATO_USER","$STRATO_PASS" sftp://ssh.strato.de <<EOF
          set sftp:auto-confirm yes
          cd /www-lsd
          rm -rf *
          mirror -R ./dist .
          bye
          EOF
        env:
          STRATO_USER: ${{ secrets.STRATO_USER }}
          STRATO_PASS: ${{ secrets.STRATO_PASS }}
