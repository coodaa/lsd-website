---
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import { fix, getFirstImage } from "../components/utils/fix.js";

const baseUrl = import.meta.env.WP_API;
const slug = Astro.params.slug;

// Seite laden
const res = await fetch(`${baseUrl}/pages?slug=${slug}`);
const data = await res.json();
const page = data[0] ?? null;

// alle Seiten (Navigation + Footer)
const allRes = await fetch(
  `${baseUrl}/pages?per_page=100&orderby=menu_order&order=asc&status=publish`
);
const pages = await allRes.json();

// Hauptnavigation
const mainPages = pages.filter((p) => p.parent === 0);

// Kontakt ans Ende schieben
// Hauptnavigation bereinigen (KEIN Impressum, KEIN Datenschutz)
let sortedMainPages = mainPages.filter((p) => {
  const t = p.title?.rendered?.toLowerCase() || "";
  return !t.includes("impressum") && !t.includes("datenschutz");
});

// "Kontakt" ans Ende schieben
const kontaktIndex = sortedMainPages.findIndex((p) => p.slug === "kontakt");
if (kontaktIndex > -1) {
  const [kontakt] = sortedMainPages.splice(kontaktIndex, 1);
  sortedMainPages.push(kontakt);
}

// Parent + Children
const parent = page ? pages.find((p) => p.id === page.parent) : null;
const children = page ? pages.filter((p) => p.parent === page.id) : [];

// Footer Seiten
const footerPages = pages.filter((p) => {
  const t = p.title?.rendered?.toLowerCase() || "";
  return t.includes("impressum") || t.includes("datenschutz");
});
---

<BaseLayout title={fix(page?.title?.rendered || "LSD Berlin")}>
  <div class="grid-layout">
    <Sidebar
      pages={sortedMainPages}
      activeSlug={slug}
      footerPages={footerPages}
    />

    <main class="content-area">
      <div class="content">
        <!-- DETAIL WRAPPER: macht X bÃ¼ndig mit dem Bild -->
        <div class="detail-wrapper">
          {
            page ? (
              <div
                class="detail-content"
                set:html={fix(page.content?.rendered || "")}
              />
            ) : (
              <p>(Seite nicht gefunden)</p>
            )
          }

          {
            parent && (
              <a href={`/${parent.slug}`} class="detail-close">
                Ã—
              </a>
            )
          }
        </div>

        <!-- UNTERSEITEN -->
        {
          children.length > 0 && (
            <div class="subpages">
              {children.map((c) => {
                const img = getFirstImage(c.content?.rendered || "");
                return (
                  <a href={`/${c.slug}`} class="subpage">
                    {img && (
                      <img src={img} alt={fix(c.title?.rendered || "")} />
                    )}
                  </a>
                );
              })}
            </div>
          )
        }
      </div>
    </main>
  </div>

  <Footer slot="footer" footerPages={footerPages} />
</BaseLayout>
