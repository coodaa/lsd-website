---
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import { fix, getFirstImage } from "../components/utils/fix.js";

const baseUrl = import.meta.env.WP_API;

// ✅ Stabil: gleich sortiert & nur published
const res = await fetch(
  `${baseUrl}/pages?per_page=100&orderby=menu_order&order=asc&status=publish`,
);
const pages = await res.json();

const mainPages = pages.filter((p) => p.parent === 0);

// Hilfs-Sortierung: menu_order → fallback Titel
const sortByMenuOrder = (a, b) => {
  const ao = Number(a?.menu_order ?? 0);
  const bo = Number(b?.menu_order ?? 0);
  if (ao !== bo) return ao - bo;
  return fix(a?.title?.rendered || "").localeCompare(
    fix(b?.title?.rendered || ""),
    "de",
  );
};

// ✅ Menü immer stabil sortieren
const sortedMainPagesAll = [...mainPages].sort(sortByMenuOrder);

// ✅ Home eindeutig (slug "lsd" bevorzugt)
const home =
  sortedMainPagesAll.find((p) => p.slug?.toLowerCase() === "lsd") ??
  sortedMainPagesAll.find(
    (p) =>
      fix(p.title?.rendered || "")
        .trim()
        .toLowerCase() === "lsd",
  ) ??
  sortedMainPagesAll[0] ??
  pages[0];

const homeSlug = home?.slug || "";

// Kinder sortieren
const children = pages
  .filter((p) => p.parent === home?.id)
  .sort(sortByMenuOrder);

// ✅ Mainpages fürs Sidebar-Menü, ohne Impressum/Datenschutz
const sortedMainPages = sortedMainPagesAll.filter((p) => {
  const t = (p.title?.rendered || "").toLowerCase();
  return !t.includes("impressum") && !t.includes("datenschutz");
});

// Footer + sortiert
const footerPages = pages
  .filter((p) => {
    const t = (p.title?.rendered || "").toLowerCase();
    return t.includes("impressum") || t.includes("datenschutz");
  })
  .sort(sortByMenuOrder);
---

<BaseLayout
  title={fix(home?.title?.rendered || "LSD Berlin")}
  bodyClass="home-page"
>
  <div class="grid-layout">
    <Sidebar
      pages={sortedMainPages}
      activeSlug={homeSlug}
      footerPages={footerPages}
    />

    <main class="content-area">
      <div class="content">
        <div class="wp-content" set:html={fix(home?.content?.rendered || "")} />

        {
          /* Home bleibt bewusst OHNE subpages--full (Teaser sollen klein bleiben) */
        }
        <div class="subpages">
          {
            children.map((c) => {
              const img = getFirstImage(c.content?.rendered || "");
              return (
                <a href={`/${c.slug}`} class="subpage">
                  {img && <img src={img} alt={fix(c.title?.rendered || "")} />}
                </a>
              );
            })
          }
        </div>
      </div>
    </main>
  </div>
</BaseLayout>
