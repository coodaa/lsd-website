---
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import { fix, getFirstImage } from "../components/utils/fix.js";

const baseUrl = import.meta.env.WP_API;

// alle Seiten laden
const res = await fetch(
  `${baseUrl}/pages?per_page=100&orderby=menu_order&order=asc&status=publish`
);
const pages = await res.json();

// Hauptseiten
const mainPages = pages.filter((p) => p.parent === 0);

// erste Seite = Startseite
const home = mainPages[0] ?? pages[0];
const homeSlug = home?.slug || "home";

// Kindseiten der Startseite
const children = pages.filter((p) => p.parent === home?.id);

// Navigation sortieren (ohne Impressum/Datenschutz)
let sortedMainPages = mainPages.filter((p) => {
  const t = p.title?.rendered?.toLowerCase() || "";
  return !t.includes("impressum") && !t.includes("datenschutz");
});

// Kontakt ans Ende
const kontaktIndex = sortedMainPages.findIndex((p) => p.slug === "kontakt");
if (kontaktIndex > -1) {
  const [kontakt] = sortedMainPages.splice(kontaktIndex, 1);
  sortedMainPages.push(kontakt);
}

// Footer-Seiten global
const footerPages = pages.filter((p) => {
  const t = p.title?.rendered?.toLowerCase() || "";
  return t.includes("impressum") || t.includes("datenschutz");
});
---

<BaseLayout title={fix(home?.title?.rendered || "LSD Berlin")}>
  <div class="grid-layout">
    <Sidebar
      pages={sortedMainPages}
      activeSlug={homeSlug}
      footerPages={footerPages}
    />

    <main class="content-area">
      <div class="content">
        <div set:html={fix(home?.content?.rendered || "")} />

        {
          children.length > 0 && (
            <div class="subpages">
              {children.map((c) => {
                const img = getFirstImage(c.content?.rendered || "");
                return (
                  <a href={`/${c.slug}`} class="subpage">
                    {img && (
                      <img src={img} alt={fix(c.title?.rendered || "")} />
                    )}
                  </a>
                );
              })}
            </div>
          )
        }
      </div>
    </main>
  </div>

  <Footer slot="footer" footerPages={footerPages} />
</BaseLayout>
